package com.allpath.textcertifier

import java.util.regex.Pattern

/**
 * ALLPATH Sanitizer
 * Purely deterministic text correction. 
 * ZERO AI/Model-based guessing allowed.
 */
class Sanitizer(private val dictionary: Set<String>) {

    // PRE-DEFINED REGEX RULES
    private val web3Pattern = Pattern.compile("(?i)web[- ]?3|web thirty", Pattern.CASE_INSENSITIVE)
    private val web2Pattern = Pattern.compile("(?i)web[- ]?2", Pattern.CASE_INSENSITIVE)
    private val trailingCurrencyPattern = Pattern.compile("(\\d+)\\s?\\$") // Matches "150 $"
    private val repeatedLetterPattern = Pattern.compile("(.)\\1{2,}") // Matches 3+ repeating letters

    fun sanitize(input: String): String? {
        var result = input.trim()

        // 1. Web2/Web3 Normalization
        result = web3Pattern.matcher(result).replaceAll("Web3")
        result = web2Pattern.matcher(result).replaceAll("Web2")

        // 2. Currency Normalization (Move $ to front: "150 $" -> "$150")
        val currencyMatcher = trailingCurrencyPattern.matcher(result)
        if (currencyMatcher.find()) {
            result = "$" + currencyMatcher.group(1)
        }

        // 3. Repeated Letter Fix (Dictionary-Validated Only)
        // If "HELLLO" -> "HELLO" (only if HELLO is in dict)
        val repeatedMatcher = repeatedLetterPattern.matcher(result)
        if (repeatedMatcher.find()) {
            val simplified = result.replace(Regex("(.)\\1+"), "$1$1") // Try double letter
            val singular = result.replace(Regex("(.)\\1+"), "$1")     // Try single letter
            
            result = when {
                dictionary.contains(singular.uppercase()) -> singular
                dictionary.contains(simplified.uppercase()) -> simplified
                else -> result // REFUSE to fix if not in dictionary (Unknown proper noun rule)
            }
        }

        // 4. Plural Handling (Safe 's' only)
        // Note: Logic here is intentionally limited to avoid changing word meaning
        if (result.endsWith("s") && !dictionary.contains(result.uppercase())) {
            val root = result.substring(0, result.length - 1)
            if (dictionary.contains(root.uppercase())) {
                // It's a valid pluralization of a known word
            }
        }

        // FINAL AUTHORITY CHECK
        // If the result is empty or vastly different from input, return null (Refusal)
        return if (result.isEmpty()) null else result
    }
}
